rm(list=ls()); graphics.off(); cat("\014")

library(reticulate)
if( .Platform$OS.type=="unix") {
  use_python(python="/home/antonio/anaconda3/envs/py3.8/bin/python",required=T)
} else {
  use_python(python="C:/Users/Antonio Candelieri/Documents/.conda/envs/py3.8",required=T)
}
conda_python("py3.8")

source("core.R")
source("AGP.R")



source.1 <- function( x ) {
  
  n.estimators <- x[1]
  learning.rate <- x[2]
  gamma <- x[3]
  reg.alpha <- x[4]
  reg.lambda <- x[5]
  subsample <- x[6]
  max.depth <- x[7]

  n.estimators <- round(round(2^n.estimators))
  learning.rate <- round(10^learning.rate,4)
  gamma <- round(gamma,4)
  reg.alpha <- round(10^reg.alpha,4)
  reg.lambda <- round(10^reg.lambda,4)
  subsample <- round(subsample,4)
  max.depth <- round(max.depth)
  
  py_run_string("dataset_name = 'COMPAS_full'")
  py_run_string("sensitive_features = ['sex.Female',
                         'race.African.American', 'race.Asian',
                         'race.Caucasian', 'race.Hispanic', 'race.Native.American']")
  py_run_string("target = 'two_year_recid'")

  # setting XGBoost's hyperparameters
  
  py$n_estimators <- as.integer(n.estimators)
  py$learning_rate <- learning.rate
  py$gamma <- gamma
  py$reg_alpha <- reg.alpha
  py$reg_lambda <- reg.lambda
  py$subsample <- subsample
  py$max_depth <- as.integer(max.depth)
  
  py_run_file("kfold_stratified_XGBoost.py")
  
  MCE <- 1-round(mean(unlist(py$res$accuracy)),4)
  DSP <- matrix(round(unlist(py$res$dsp),4),ncol=length(py$sensitive_features),byrow=T)
  DSP <- max(apply(DSP,1,mean))
  
  return( c(MCE,DSP) )
  
}
  
source.2 <- function( x ) {
  
  n.estimators <- x[1]
  learning.rate <- x[2]
  gamma <- x[3]
  reg.alpha <- x[4]
  reg.lambda <- x[5]
  subsample <- x[6]
  max.depth <- x[7]
  
  n.estimators <- round(round(2^n.estimators))
  learning.rate <- round(10^learning.rate,4)
  gamma <- round(gamma,4)
  reg.alpha <- round(10^reg.alpha,4)
  reg.lambda <- round(10^reg.lambda,4)
  subsample <- round(subsample,4)
  max.depth <- round(max.depth)
  
  py_run_string("dataset_name = 'COMPAS_redux'")
  py_run_string("sensitive_features = ['sex.Female',
                         'race.African.American', 'race.Asian',
                         'race.Caucasian', 'race.Hispanic', 'race.Native.American']")
  py_run_string("target = 'two_year_recid'")
  
  # setting XGBoost's hyperparameters
  
  py$n_estimators <- as.integer(n.estimators)
  py$learning_rate <- learning.rate
  py$gamma <- gamma
  py$reg_alpha <- reg.alpha
  py$reg_lambda <- reg.lambda
  py$subsample <- subsample
  py$max_depth <- as.integer(max.depth)
  
  py_run_file("kfold_stratified_XGBoost.py")
  
  MCE <- 1-round(mean(unlist(py$res$accuracy)),4)
  DSP <- matrix(round(unlist(py$res$dsp),4),ncol=length(py$sensitive_features),byrow=T)
  DSP <- max(apply(DSP,1,mean))
  
  return( c(MCE,DSP) )
  
}  

sources <- list( source.1, source.2 )


d <- 7 # XGboost's hyperparameters
Omega <- matrix( NA, d, 2 )
colnames(Omega) <- c("min","max")
# number of estimators (integer - log2
Omega[1,'min'] <- log(1,2); Omega[1,'max'] <- log(256,2)
# learning rate (log10)
Omega[2,'min'] <- log(10^-2,10); Omega[2,'max'] <- log(1,10)
# gamma (double)
Omega[3,'min'] <- 0.0; Omega[3,'max'] <- 0.1 
# reg.alpha (log10)
Omega[4,'min'] <- log(10^-3,10); Omega[4,'max'] <- log(10^3,10)
# reg.lambda (log10)
Omega[5,'min'] <- log(10^-3,10); Omega[5,'max'] <- log(10^3,10) 
# subsample (double)
Omega[6,'min'] <- 0.01; Omega[6,'max'] <- 1.0 
# max.depth (integer)
Omega[7,'min'] <- 1; Omega[7,'max'] <- 16 



files.1 <- sort(list.files("XGB_initial_designs",pattern="_FULL_", ))
files.2 <- sort(list.files("XGB_initial_designs",pattern="_REDUX_" ))
stopifnot( length(files.1)==length(files.2) )
n.independent.runs <- length(files.1)


for( exp.id in 1:n.independent.runs ) {
  
  cat("\014")
  cat("***** Experiment",exp.id,"*****\n")
  
  X <- list()
  Y <- list()

  cat("> Loading initial design for SOURCE #1 (FULL)...\n")
  cat("   file: \"",files.1[exp.id],"\"\n")
  X[[1]] <- as.matrix(read.delim( paste0("XGB_initial_designs/",files.1[exp.id]), sep="," ))
  
  cat("> Loading initial design for SOURCE #2 (REDUX)...\n")
  cat("   file: \"",files.2[exp.id],"\"\n")
  X[[2]] <- as.matrix(read.delim( paste0("XGB_initial_designs/",files.2[exp.id]), sep="," ))

  stopifnot( nrow(X[[1]])==nrow(X[[2]]) )
  
  
  # source 1
  cat("> Evaluating initial design for SOURCE #1 (FULL)...\n")
  
  elapsed <- Sys.time()
  
  for( i in 1:nrow(X[[1]]) ) {
    
    cat(".")
    tmp <- source.1( X[[1]][i,] )
    
    if( i==1 ) {
      Y[[1]] <- tmp 
    } else {
      Y[[1]] <- rbind(Y[[1]], tmp, deparse.level=0 )
    }
    
    
  }
  cat("\n")
  
  cat("Elapsed:", round(as.numeric(difftime(Sys.time(),elapsed,units="secs")),3),"\n" )
  
  
  # source 2
  cat("> Evaluating initial design for SOURCE #2 (REDUX)...\n")
  
  elapsed <- Sys.time()
  
  for( i in 1:nrow(X[[2]]) ) {
    
    cat(".")
    tmp <- source.2( X[[2]][i,] )
    
    if( i==1 ) {
      Y[[2]] <- tmp  
    } else {
      Y[[2]] <- rbind(Y[[2]], tmp, deparse.level=0 )
    }
    
  }
  
  cat("\n")
  
  cat("Elapsed:", round(as.numeric(difftime(Sys.time(),elapsed,units="secs")),3),"\n" )
  
  
  sources.costs <- c(2,1) # from preliminary analysis
  initially.paid <- nrow(X[[1]])*sources.costs[1] + nrow(X[[2]])*sources.costs[2]
  
  run.info <- FanG_BO.run( search.space=Omega,
                           sources=sources,
                           n.objectives=2,
                           sources.costs=sources.costs, #sources.costs=c(100,1),
                           initial.X=X,
                           initial.Y=Y,
                           initially.paid=initially.paid,
                           budget=20*d,
                           kernel="matern3_2",
                           noisy=T,
                           dgt=4,
                           seed=exp.id,
                           y.ref=c(1,1),
                           check.for.setting=F,
                           p=NA)
  
  cat("> Saving results...")
  if( !dir.exists("results") )
    dir.create("results")
  saveRDS( object=run.info, file=paste0("results/results_COMPAS_XGB_expid_",exp.id,".RDS") )
  cat(" done!\n")
}
